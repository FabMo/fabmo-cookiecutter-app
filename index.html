<!DOCTYPE html>

<html lang="en"> 
<head>
	<title>Cookie Cutter</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" charset="utf-8"/>
	<link href="css/style.css" rel="stylesheet">
	<script src="js/libs/jquery-1.11.2.min.js"></script>
	<script src="js/libs/fabmo.min.js"></script>
	<script src="js/libs/Sortable.min.js"></script>
	<script src="js/libs/fabmo.min.js"></script>

</head>

<body onload="">

<select id="job-group">
	<option id="group1" value="1">Group 1</option>
	<!--
	<option id="group2">Group 2</option>
	-->
</select>

<select id="addJob" autocomplete="off">
	<option value="add" selected disabled>+ Add Job</option>
	<!--
	<option value="computer" selected>Computer</option>
	-->
	<option value="history" selected>History</option>
	<!--
	<option value="queue">Queue</option>
	-->
</select>

<div id="recent-jobs">
	<li id="r0" data-id="r0" value="r0">partX</li>
	<li id="r1" data-id="r1" value="r1">partY</li>
	<li id="r2" data-id="r2" value="r2">partZ</li>
	<li id="r3" data-id="r3" value="r3">partA</li>
	<li id="r4" data-id="r4" value="r4">partB</li>	
	<p id="link" value="0">1 - 5 <a href="#" onclick="next()">next</a>
</div>

<div id="my-ui-list">
	<!--
	<li id="default" data-id="default" value="default">drag and drop here</li>
	-->
	<li id="0" data-id="0" value="0">part0</li>
	<li id="1" data-id="1" value="1">part1</li>
	<li id="2" data-id="2" value="2">part2</li>
	<li id="3" data-id="3" value="3">part3</li>
	<li id="4" data-id="4" value="4">part4</li>
	<li id="5" data-id="5" value="5">part5</li>
	<li id="6" data-id="6" value="6">part6</li>
</div>

<div id="job-icons">
	<input class="trash" type="image" id="trash0" src="css/trash.png" onclick="removeJob(this.id)"/>
</div>

<div id="icons">
	<input type="image" id="new" src="css/new.png" onclick="newGroup()"/>
	<input type="image" id="gear" src="css/gear.png" onclick=""/>
	<input type="image" id="play" src="css/play_icon.png" onclick="make()"/>
</div>

</body>

<script>

//TODO
//
//cleanup
//unique job list id
//save list
//settings
//

var fabmo = new FabMoDashboard()
var fabmoHistory = []
var historyCount = 0
var historyIndex = 0
var jobOrder = [0,1,2,3,4,5,6] 
var recentOrder = ['r0','r1','r2','r3','r4']
var list = document.getElementById("my-ui-list")
var jobHistory = document.getElementById("recent-jobs")

var sortable2 = new Sortable(jobHistory, {
	group: {name:"group1", pull: ['clone'], put: [false] },
	sort: false,
	animation: 250,
	dataIdAttr: 'id',
	onUpdate: function (e) {
		//console.log(e)
		//console.log(sortable2.toArray())
	},
	onSort: function (e) {
		//console.log(e)
		//console.log('2:')
		//console.log(sortable2.toArray())
	},
	onClone: function (e) {
		console.log(e.item.id)
		e.item.id = ((Math.random()).toFixed(6)).replace('.','')+e.item.id
	}

})

var sortable = new Sortable(list, {
	group:"group1",
	sort:true,
	animation: 250,
	dataIdAttr: 'id',
	onEnd: function(e){
		//console.log(e)
		//console.log(e.oldIndex)
		//console.log(e.newIndex)  
	},
	onAdd: function(e){
		//var itemEl = e.item;  // dragged HTMLElement
		//e.from;  // previous list
		// + indexes from onEnd
		//console.log(e.item)
	},
	onSort: function(e){
		//console.log(e)
		
		jobOrder=sortable.toArray()
		console.log(jobOrder)

		for(i=0;i<jobOrder.length;i++){
			if(jobOrder[i]=='default'){
				document.getElementById("default").remove()
				jobOrder.splice(i,1)
				document.getElementById("play").style.display="block"			
			}
		}
		//console.log(jobOrder)
		sortable.sort(jobOrder)
		$("#job-icons").empty()

		colorUpdate()

		for(i=0;i<jobOrder.length;i++){
			var top = i*70+100
			$("#job-icons").append("<input class=\"trash\" type=\"image\" id=\"trash" + jobOrder[i] + "\" style=\"top:" + top + "px\" src=\"css/trash.png\" onclick=\"removeJob(this.id)\"\/\>")
			$("#job-icons").append("<input class=\"gear\" type=\"image\" id=\"gear" + jobOrder[i] + "\" style=\"top:" + top + "px\" src=\"css/gear.png\" onclick=\"\"\/\>")
		}	
	}

})

function getHistory(){

	if(fabmo.isPresent()==true){

		$("#my-ui-list").empty()
		defaultDisplay()
	
		for(i=0;i<recentOrder.length;i++){
			document.getElementById(recentOrder[i]).remove();
		}
		document.getElementById("link").remove();

		fabmo.getJobHistory({start:0,count:5},function(err, myHistory) {
			fabmoHistory = myHistory
			console.log(fabmoHistory)

			if(fabmoHistory.data.length>0){
				historyTotal = fabmoHistory.total_count
				if(historyTotal>5){
					var Next = true
				}
				else{
					var Next =false
				}
				console.log(historyTotal)
				for(i=0;i<fabmoHistory.data.length;i++){
					$("#recent-jobs").append("<li id=\"" + fabmoHistory.data[i]._id + "\" data-id=\"" + fabmoHistory.data[i]._id +"\" value=\"r4\">" + fabmoHistory.data[i].name + "</li>")
				}
				if(Next==true){
					$("#recent-jobs").append("<p id=\"link\" value=\"" + historyIndex + "\">1 - 5 <a href=\"#\" onclick=\"next()\">next</a>")
				}
				else{
					$("#recent-jobs").append("<p id=\"link\" value=\"" + historyIndex + "\">1 - " + (historyTotal))
					//update div height
				}

			}
			else{
				console.log("no jobs in history")
			}
		})

	}

}

function next(){
	if(historyTotal>historyIndex+5){
		historyIndex+=5
		if(historyTotal>historyIndex+5){
			var Next = true
		}
		else{
			var Next = false
		}
		fabmo.getJobHistory({start:(historyIndex),count:5},function(err, myHistory) {
			fabmoHistory = myHistory
			$("#recent-jobs").children("li").remove()
			document.getElementById("link").remove()
			
			console.log(fabmoHistory)

			for(i=0;i<fabmoHistory.data.length;i++){
				$("#recent-jobs").append("<li id=\"" + fabmoHistory.data[i]._id + "\" data-id=\"" + fabmoHistory.data[i]._id +"\" value=\"r4\">" + fabmoHistory.data[i].name + "</li>")
			}
			if(Next==true){			
			$("#recent-jobs").append("<p id=\"link\" value=\"" + historyIndex + "\"><a href=\"#\" onclick=\"prev()\">prev</a> " + (historyIndex+1) + " - " + (historyIndex+5) + " <a href=\"#\" onclick=\"next()\">next</a>")
			}
			else{
				$("#recent-jobs").append("<p id=\"link\" value=\"" + historyIndex + "\"><a href=\"#\" onclick=\"prev()\">prev</a> " + (historyIndex+1) + " - " + (historyTotal))
			}
		})
	}
}

function prev(){
	if(historyIndex>=5){
		historyIndex-=5
		if(historyTotal>5){
			var Next = true
		}
		else{
			var Next = false
		}
		if(historyIndex>=5){
			var Prev = true
		}
		else{
			var Prev = false
		}
		fabmo.getJobHistory({start:(historyIndex),count:5},function(err, myHistory) {
			fabmoHistory = myHistory
			$("#recent-jobs").children("li").remove()
			document.getElementById("link").remove()
			
			console.log(fabmoHistory)
			for(i=0;i<fabmoHistory.data.length;i++){
				$("#recent-jobs").append("<li id=\"" + fabmoHistory.data[i]._id + "\" data-id=\"" + fabmoHistory.data[i]._id +"\" value=\"r4\">" + fabmoHistory.data[i].name + "</li>")
			}

			if((Next==true)&&(Prev==true)){			
				$("#recent-jobs").append("<p id=\"link\" value=\"" + historyIndex + "\"><a href=\"#\" onclick=\"prev()\">prev</a> " + (historyIndex+1) + " - " + (historyIndex+5) + " <a href=\"#\" onclick=\"next()\">next</a>")
			}
			else if((Next==true)&&(Prev==false)){			
				$("#recent-jobs").append("<p id=\"link\" value=\"" + historyIndex + "\">" + (historyIndex+1) + " - " + (historyIndex+5) + " <a href=\"#\" onclick=\"next()\">next</a>")
			}
			else{
				$("#recent-jobs").append("<p id=\"link\" value=\"" + historyIndex + "\"> 1 - " + (historyTotal))
			}
		})
	}

}

function removeJob(id){

	var remove = id.replace("trash", "")

	console.log(remove)

	$("#my-ui-list").children("#" + remove).remove()

	$("#job-icons").empty()
	jobOrder=sortable.toArray()

	for(i=0;i<jobOrder.length;i++){
		var top = i*70+100
		$("#job-icons").append("<input class=\"trash\" type=\"image\" id=\"trash" + jobOrder[i] + "\" style=\"top:" + top + "px\" src=\"css/trash.png\" onclick=\"removeJob(this.id)\"\/\>")
		$("#job-icons").append("<input class=\"gear\" type=\"image\" id=\"gear" + jobOrder[i] + "\" style=\"top:" + top + "px\" src=\"css/gear.png\" onclick=\"\"\/\>")
	}
	colorUpdate()
	if(jobOrder.length==0){
		defaultDisplay()
	}

}

function defaultDisplay(){
	jobOrder=['default']
	$("#job-icons").empty()
	$("#my-ui-list").append("<li id=\"default\" data-id=\"default\" value=\"default\">+ add job</li>")
	document.getElementById("default").style.background="#ff00ff"
	document.getElementById("play").style.display="none"
}

function colorUpdate(){

	$("#my-ui-list").children("*").css('background','#7777ff')
	$("#my-ui-list").children(":first").css('background','#eeee55')

}


function make(){

	//fabmo.runGCode("g0x0")

	var makeId = jobOrder[0].substring(7)

	fabmo.resubmitJob(makeId)


	jobOrder.push(jobOrder[0])
	jobOrder.splice(0,1)
	sortable.sort(jobOrder)
	colorUpdate()

	console.log(jobOrder)
}

function newGroup(){
	makeGroup = (parseInt($("#job-group").children(":last").val()))+1
	console.log(makeGroup)
	//makeGroup = document.getElementById('group' + id).value++
	$("#job-group").append("<option id=\"group" + makeGroup + "\" value=\"" + makeGroup + "\">Group " + makeGroup + " </option>")
	$("#job-group").val(makeGroup)
	$("#my-ui-list").empty()
	$("#job-icons").empty()
	defaultDisplay()
}

//

for(i=1;i<jobOrder.length;i++){
	$("#job-icons").append("<input class=\"trash\" type=\"image\" id=\"trash" + i + "\" src=\"css/trash.png\" onclick=\"removeJob(this.id)\"\/\>")
	document.getElementById("trash"+i).style.top = i*70 + 100 + "px"

	$("#job-icons").append("<input class=\"gear\" type=\"image\" id=\"gear" + i + "\" src=\"css/gear.png\" onclick=\"\"\/\>")
	document.getElementById("gear"+i).style.top = i*70 + 100 + "px"
}

getHistory()

</script>


</html>

